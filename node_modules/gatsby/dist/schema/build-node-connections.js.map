{"version":3,"sources":["../../src/schema/build-node-connections.js"],"names":["_","require","connectionArgs","connectionDefinitions","GraphQLInputObjectType","inferInputObjectStructureFromNodes","buildConnectionFields","getNodes","module","exports","types","connections","each","type","nodes","nodeType","nodeObjectType","connectionFields","typeConnection","connectionType","typeName","name","sort","inferredFields","camelCase","description","args","filter","fields","resolve","object","resolveArgs","b","rootValue","path","componentChunkName","includes","id","runSift","latestNodes","n","internal","connection"],"mappings":";;;;;;;;AACA,IAAMA,IAAIC,QAAS,QAAT,CAAV;;eACkDA,QAAS,oBAAT,C;IAA1CC,c,YAAAA,c;IAAgBC,qB,YAAAA,qB;;gBACWF,QAAS,SAAT,C;IAA3BG,sB,aAAAA,sB;;gBAGJH,QAAS,8BAAT,C;IADFI,kC,aAAAA,kC;;AAEF,IAAMC,wBAAwBL,QAAS,2BAAT,CAA9B;;gBACqBA,QAAS,UAAT,C;IAAbM,Q,aAAAA,Q;;AAERC,OAAOC,OAAP,GAAiB,UAACC,KAAD,EAAgB;AAC/B,MAAMC,cAAc,EAApB;;AAEAX,IAAEY,IAAF,CAAOF,KAAP,EAAc,UAACG,IAAD,CAAM,gBAAN,EAA2B;AACvC,QAAMC,QAAQD,KAAKC,KAAnB;;AADuC,gCAEIX,sBAAsB;AAC/DY,gBAAUF,KAAKG,cADgD;AAE/DC,wBAAkB;AAAA,eAAMX,sBAAsBO,IAAtB,CAAN;AAAA;AAF6C,KAAtB,CAFJ;AAAA,QAEfK,cAFe,yBAE/BC,cAF+B;;AAAA,gCAONd,mCAAmC;AAClES,WADkE;AAElEM,gBAAW,GAAEP,KAAKQ,IAAK;AAF2C,KAAnC,CAPM;AAAA,QAO/BC,IAP+B,yBAO/BA,IAP+B;AAAA,QAOzBC,cAPyB,yBAOzBA,cAPyB;;AAYvCZ,gBAAYX,EAAEwB,SAAF,CAAa,OAAMX,KAAKQ,IAAK,EAA7B,CAAZ,IAA+C;AAC7CR,YAAMK,cADuC;AAE7CO,mBAAc,qBAAoBZ,KAAKQ,IAAK,QAFC;AAG7CK,uCACKxB,cADL;AAEEoB,YAFF;AAGEK,gBAAQ;AACNd,gBAAM,IAAIT,sBAAJ,CAA2B;AAC/BiB,kBAAMrB,EAAEwB,SAAF,CAAa,UAASX,KAAKQ,IAAK,EAAhC,CADyB;AAE/BI,yBAAc,iCAFiB;AAG/BG,oBAAQ;AAAA,qBAAML,cAAN;AAAA;AAHuB,WAA3B;AADA;AAHV,QAH6C;AAc7CM,cAAQC,MAAR,EAAgBC,WAAhB,EAA6BC,CAA7B,QAA+C;AAAA,YAAbC,SAAa,QAAbA,SAAa;;AAC7C,YAAIC,aAAJ;AACA,YAAI,OAAOD,SAAP,KAAsB,WAA1B,EAAsC;AACpCC,iBAAOD,UAAUC,IAAjB;AACD;AACD;AACA,YACE,CAACA,IAAD,IACAD,SADA,IAEAA,UAAUE,kBAFV,IAGAnC,EAAEoC,QAAF,CAAWH,UAAUE,kBAArB,EAA0C,QAA1C,CAJF,EAKE;AACAD,iBAAQ,YAAWD,UAAUI,EAAG,EAAhC;AACD;AACD,YAAMC,UAAUrC,QAAS,YAAT,CAAhB;AACA,YAAMsC,cAAcvC,EAAE2B,MAAF,CAClBpB,UADkB,EAElB;AAAA,iBAAKiC,EAAEC,QAAF,CAAW5B,IAAX,KAAoBA,KAAKQ,IAA9B;AAAA,SAFkB,CAApB;AAIA,eAAOiB,QAAQ;AACbZ,gBAAMK,WADO;AAEbjB,iBAAOyB,WAFM;AAGbG,sBAAY,IAHC;AAIbR;AAJa,SAAR,CAAP;AAMD;AAvC4C,KAA/C;AAyCD,GArDD;;AAuDA,SAAOvB,WAAP;AACD,CA3DD","file":"build-node-connections.js","sourcesContent":["// @flow\nconst _ = require(`lodash`)\nconst { connectionArgs, connectionDefinitions } = require(`graphql-skip-limit`)\nconst { GraphQLInputObjectType } = require(`graphql`)\nconst {\n  inferInputObjectStructureFromNodes,\n} = require(`./infer-graphql-input-fields`)\nconst buildConnectionFields = require(`./build-connection-fields`)\nconst { getNodes } = require(`../redux`)\n\nmodule.exports = (types: any) => {\n  const connections = {}\n\n  _.each(types, (type /* , fieldName*/) => {\n    const nodes = type.nodes\n    const { connectionType: typeConnection } = connectionDefinitions({\n      nodeType: type.nodeObjectType,\n      connectionFields: () => buildConnectionFields(type),\n    })\n\n    const { sort, inferredFields } = inferInputObjectStructureFromNodes({\n      nodes,\n      typeName: `${type.name}Connection`,\n    })\n\n    connections[_.camelCase(`all ${type.name}`)] = {\n      type: typeConnection,\n      description: `Connection to all ${type.name} nodes`,\n      args: {\n        ...connectionArgs,\n        sort,\n        filter: {\n          type: new GraphQLInputObjectType({\n            name: _.camelCase(`filter ${type.name}`),\n            description: `Filter connection on its fields`,\n            fields: () => inferredFields,\n          }),\n        },\n      },\n      resolve(object, resolveArgs, b, { rootValue }) {\n        let path\n        if (typeof rootValue !== `undefined`) {\n          path = rootValue.path\n        }\n        // If path isn't set, this is probably a layout\n        if (\n          !path &&\n          rootValue &&\n          rootValue.componentChunkName &&\n          _.includes(rootValue.componentChunkName, `layout`)\n        ) {\n          path = `LAYOUT___${rootValue.id}`\n        }\n        const runSift = require(`./run-sift`)\n        const latestNodes = _.filter(\n          getNodes(),\n          n => n.internal.type === type.name\n        )\n        return runSift({\n          args: resolveArgs,\n          nodes: latestNodes,\n          connection: true,\n          path,\n        })\n      },\n    }\n  })\n\n  return connections\n}\n"]}